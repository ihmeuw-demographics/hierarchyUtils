<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Aggregate/Scale a detailed level of a hierarchical variable to an
aggregate level — agg • hierarchyUtils</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Aggregate/Scale a detailed level of a hierarchical variable to an
aggregate level — agg" />
<meta property="og:description" content="Aggregate counts or probabilities from a detailed level of a
hierarchical variable to an aggregate level or scale the detailed level
values so that the detailed level aggregated together equals the aggregate
level." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hierarchyUtils</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/hierarchyUtils.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/ihmeuw-demographics/hierarchyUtils/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Aggregate/Scale a detailed level of a hierarchical variable to an
aggregate level</h1>
    <small class="dont-index">Source: <a href='https://github.com/ihmeuw-demographics/hierarchyUtils/blob/master/R/agg_scale.R'><code>R/agg_scale.R</code></a></small>
    <div class="hidden name"><code>agg_scale.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Aggregate counts or probabilities from a detailed level of a
hierarchical variable to an aggregate level or scale the detailed level
values so that the detailed level aggregated together equals the aggregate
level.</p>
    </div>

    <pre class="usage"><span class='fu'>agg</span>(
  <span class='kw'>dt</span>,
  <span class='kw'>id_cols</span>,
  <span class='kw'>value_cols</span>,
  <span class='kw'>col_stem</span>,
  <span class='kw'>col_type</span>,
  <span class='kw'>mapping</span>,
  agg_function = <span class='kw'>sum</span>,
  missing_dt_severity = <span class='st'>"stop"</span>,
  drop_present_aggs = <span class='fl'>FALSE</span>,
  collapse_interval_cols = <span class='fl'>FALSE</span>
)

<span class='fu'>scale</span>(
  <span class='kw'>dt</span>,
  <span class='kw'>id_cols</span>,
  <span class='kw'>value_cols</span>,
  <span class='kw'>col_stem</span>,
  <span class='kw'>col_type</span>,
  mapping = <span class='kw'>NULL</span>,
  agg_function = <span class='kw'>sum</span>,
  missing_dt_severity = <span class='st'>"stop"</span>,
  collapse_missing = <span class='fl'>FALSE</span>,
  collapse_interval_cols = <span class='fl'>FALSE</span>
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>dt</th>
      <td><p>[<code>data.table()</code>]<br />
Data to be aggregated or scaled.</p></td>
    </tr>
    <tr>
      <th>id_cols</th>
      <td><p>[<code><a href='https://rdrr.io/r/base/character.html'>character()</a></code>]<br />
ID columns that uniquely identify each row of <code>dt</code>.</p></td>
    </tr>
    <tr>
      <th>value_cols</th>
      <td><p>[<code><a href='https://rdrr.io/r/base/character.html'>character()</a></code>]<br />
Value columns that should be aggregated.</p></td>
    </tr>
    <tr>
      <th>col_stem</th>
      <td><p>[<code><a href='https://rdrr.io/r/base/character.html'>character(1)</a></code>]<br />
The name of the variable to be aggregated or scaled over. If aggregating an
'interval' variable should not include the '_start' or '_end' suffix.</p></td>
    </tr>
    <tr>
      <th>col_type</th>
      <td><p>[<code><a href='https://rdrr.io/r/base/character.html'>character(1)</a></code>]<br />
The type of variable that is being aggregated or scaled over. Can be either
'categorical' or 'interval'.</p></td>
    </tr>
    <tr>
      <th>mapping</th>
      <td><p>[<code>data.table()</code>]<br />
For 'categorical' variables, defines how different levels of the
hierarchical variable relate to each other. For aggregating 'interval'
variables, it is used to specify intervals to aggregate to, while when
scaling the mapping is inferred from the available intervals in <code>dt</code>.</p></td>
    </tr>
    <tr>
      <th>agg_function</th>
      <td><p>[<code>function()</code>]<br />
Function to use when aggregating, can be either <code>sum</code> (for counts) or
<code>prod</code> (for probabilities).</p></td>
    </tr>
    <tr>
      <th>missing_dt_severity</th>
      <td><p>[<code><a href='https://rdrr.io/r/base/character.html'>character(1)</a></code>]<br />
How severe should the consequences of missing data that prevents
aggregation or scaling from occurring be? Can be either 'stop', 'warning',
'message', or 'none'. If not "stop", then only the possible aggregations or
scaling is done using the available data.</p></td>
    </tr>
    <tr>
      <th>drop_present_aggs</th>
      <td><p>[<code><a href='https://rdrr.io/r/base/logical.html'>logical(1)</a></code>]<br />
Whether to drop aggregates (or overlapping intervals) that are already
present in <code>dt</code> before aggregating. Default is 'False' and the function
errors out.</p></td>
    </tr>
    <tr>
      <th>collapse_interval_cols</th>
      <td><p>[<code><a href='https://rdrr.io/r/base/logical.html'>logical(1)</a></code>]<br />
Whether to collapse interval <code>id_cols</code> (not including <code>col_stem</code> if it is
an interval variable). Default is 'False'. If set to 'True' the interval
columns are collapsed to the most detailed common intervals and will error
out if there are overlapping intervals. See details or vignettes for more
information.</p></td>
    </tr>
    <tr>
      <th>collapse_missing</th>
      <td><p>[<code><a href='https://rdrr.io/r/base/logical.html'>logical(1)</a></code>]<br />
When scaling a <code>categorical</code> variable, whether to collapse missing
intermediate levels in <code>mapping</code>. Default is 'False' and the function
errors out due to missing data.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>[<code>data.table()</code>] with <code>id_cols</code> and <code>value_cols</code> columns for
requested aggregates or with scaled values.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The <code>agg</code> function can be used to aggregate to different levels of a pre
defined hierarchy. For example a categorical variable like location you can
aggregate the country level to global level or for a numeric 'interval'
variable like age you can aggregate from  five year age-groups to all-ages
combined.</p>
<p>The <code>scale</code> function can be used to scale different levels of hierarchical
variables like location, so that the sub-national level aggregated together
equals the national level. Similarly, it can be used to scale a numeric
'interval' variable like age so that the five year age groups aggregated
together equals the all-ages value.</p>
<p>If 'location' is the variable to be aggregated or scaled then
<code>col_stem = 'location'</code> and 'location' must be included in <code>id_cols.</code> If
'age' is the variable to be aggregated or scaled then <code>col_stem = 'age'</code> and
'age_start' and 'age_end' must be included in <code>id_cols</code> since both variables
are needed to represent interval variables.</p>
<p>The <code>mapping</code> argument defines how different levels of the hierarchical
variable relate to each other. For numeric interval variables the hierarchy
can be inferred while for categorical variables the full hierarchy needs to
be provided.</p>
<p><code>mapping</code> for categorical variables must have columns called 'parent' and
'child' that represent how each possible variable relates to each other.
For example if aggregating or scaling locations then mapping needs to define
how each child location relates to each parent location. It is then assumed
that each parent location in the <code>mapping</code> hierarchy will need to be
aggregated to.</p>
<p><code>mapping</code> for numeric interval variables is only needed when aggregating data
to define exactly which aggregates are needed. It must have columns for
'<code>{col_stem}</code>_start' and '<code>{col_stem}</code>_end' defining the start and end of each
aggregate interval that is need. When scaling data, <code>mapping</code> should be
<code>NULL</code> since the hierarchy can be inferred from the available intervals in
<code>dt</code>.</p>
<p><code>agg</code> and <code>scale</code> work even if <code>dt</code> is not a square dataset. Meaning it is
okay if different combinations of <code>id_vars</code> have different <code>col_stem</code> values
available. For example if making age aggregates, it is okay if some
location-years have 5-year age groups while other location-years have 1-year
age groups.</p>
<p>If <code>collapse_interval_cols = TRUE</code> it is okay if the interval variables
included in <code>id_vars</code> are not all exactly the same, <code>agg</code> and <code>scale</code> will
collapse to the most detailed common intervals
<code><a href='collapse_common_intervals.html'>collapse_common_intervals()</a></code> prior to aggregation or scaling. An example
of this is when aggregating subnational data to the national level (so
<code>col_stem</code> is 'location' and <code>col_type</code> is 'categorical') but each
subnational location contains different age groups. <code>agg()</code> and <code>scale()</code>
first aggregate to the most detailed common age groups before making location
aggregates.</p>
<p>The <code>agg</code> and <code>scale</code> functions currently only work when combining counts or
probabilities. If the data is in rate-space then you need to convert to count
space first, aggregate/scale, and then convert back.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># aggregate count data from present day Iran provinces to historical</span>
<span class='co'># provinces and Iran as a whole</span>
<span class='kw'>input_dt</span> <span class='op'>&lt;-</span> <span class='kw'>data.table</span>::<span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/J.html'>CJ</a></span>(location = <span class='kw'>iran_mapping</span>[<span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/grep.html'>grepl</a></span>(<span class='st'>"[0-9]+"</span>, <span class='kw'>child</span>),
                                                   <span class='kw'>child</span>],
                           year = <span class='fl'>2011</span>,
                           value = <span class='fl'>1</span>)
<span class='kw'>output_dt</span> <span class='op'>&lt;-</span> <span class='fu'>agg</span>(dt = <span class='kw'>input_dt</span>,
                 id_cols = <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"location"</span>, <span class='st'>"year"</span>),
                 value_cols = <span class='st'>"value"</span>,
                 col_stem = <span class='st'>"location"</span>,
                 col_type = <span class='st'>"categorical"</span>,
                 mapping = <span class='kw'>iran_mapping</span>)

<span class='co'># scale count data from present day Iran provinces to Iran national value</span>
<span class='kw'>input_dt</span> <span class='op'>&lt;-</span> <span class='kw'>data.table</span>::<span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/J.html'>CJ</a></span>(location = <span class='kw'>iran_mapping</span>[<span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/grep.html'>grepl</a></span>(<span class='st'>"[0-9]+"</span>, <span class='kw'>child</span>),
                                                   <span class='kw'>child</span>],
                           year = <span class='fl'>2011</span>,
                           value = <span class='fl'>1</span>)
<span class='kw'>input_dt_agg</span> <span class='op'>&lt;-</span> <span class='kw'>data.table</span>::<span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/data.table.html'>data.table</a></span>(
  location = <span class='st'>"Iran (Islamic Republic of)"</span>,
  year = <span class='fl'>2011</span>, value = <span class='fl'>62</span>
)
<span class='kw'>input_dt</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span>(<span class='kw'>input_dt</span>, <span class='kw'>input_dt_agg</span>)
<span class='kw'>output_dt</span> <span class='op'>&lt;-</span> <span class='fu'>scale</span>(dt = <span class='kw'>input_dt</span>,
                   id_cols = <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"location"</span>, <span class='st'>"year"</span>),
                   value_cols = <span class='st'>"value"</span>,
                   col_stem = <span class='st'>"location"</span>,
                   col_type = <span class='st'>"categorical"</span>,
                   mapping = <span class='kw'>iran_mapping</span>,
                   collapse_missing = <span class='fl'>TRUE</span>)
</div><div class='output co'>#&gt; [1] "Node$fields will be deprecated in the next release. Please use Node$attributes instead."</div><div class='input'>
<span class='co'># aggregate age-specific count data</span>
<span class='kw'>input_dt</span> <span class='op'>&lt;-</span> <span class='kw'>data.table</span>::<span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/data.table.html'>data.table</a></span>(year = <span class='fl'>2010</span>,
                        age_start = <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span>(<span class='fl'>0</span>, <span class='fl'>95</span>, <span class='fl'>1</span>),
                        value1 = <span class='fl'>1</span>, value2 = <span class='fl'>2</span>)
<span class='fu'><a href='gen_end.html'>gen_end</a></span>(<span class='kw'>input_dt</span>, id_cols = <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"year"</span>, <span class='st'>"age_start"</span>), col_stem = <span class='st'>"age"</span>)
<span class='kw'>age_mapping</span> <span class='op'>&lt;-</span> <span class='kw'>data.table</span>::<span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/data.table.html'>data.table</a></span>(age_start = <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fl'>0</span>, <span class='fl'>15</span>, <span class='fl'>85</span>),
                                      age_end = <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fl'>5</span>, <span class='fl'>60</span>, <span class='fl'>Inf</span>))
<span class='kw'>output_dt</span> <span class='op'>&lt;-</span> <span class='fu'>agg</span>(dt = <span class='kw'>input_dt</span>,
                 id_cols = <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"year"</span>, <span class='st'>"age_start"</span>, <span class='st'>"age_end"</span>),
                 value_cols = <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"value1"</span>, <span class='st'>"value2"</span>),
                 col_stem = <span class='st'>"age"</span>,
                 col_type = <span class='st'>"interval"</span>,
                 mapping = <span class='kw'>age_mapping</span>)

<span class='co'># scale age-specific probability data</span>

</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Charlton Callender, Grant Nguyen, Katie Paulson, Spencer Pease, Haidong Wang, Institute for Health Metrics and Evaluation.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.0.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


